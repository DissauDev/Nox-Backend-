datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/// Categor√≠as generales (Desserts, Ice Cream, Cookies‚Ä¶)
model Category {
  id               String        @id @default(uuid())
  name             String        @unique
  status           ProductStatus @default(AVAILABLE)
  onCarousel       Boolean       @default(true)
  imageUrl         String
  shortDescription String
  longDescription  String
  createdAt        DateTime      @default(now())
  products         Product[]
  sortOrder        Int           @default(1)

  @@index([sortOrder, name])
}

model ProductCateringTier {
  id        String  @id @default(uuid())
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  minQty Int // desde esta cantidad (incluida)
  maxQty Int? // hasta esta cantidad (incluida); null = infinito
  price  Float // precio unitario para este rango

  createdAt DateTime @default(now())

  @@index([productId, minQty, maxQty])
}

/// Producto principal
model Product {
  id                  String                @id @default(uuid())
  name                String                @unique
  price               Float
  salePrice           Float?                @map("sellPrice")
  specifications      String?
  description         String?
  imageLeft           Json? // { url, blurHash }
  imageRight          Json?
  type                ProductType           @default(REGULAR)
  status              ProductStatus         @default(AVAILABLE)
  categoryId          String
  category            Category              @relation(fields: [categoryId], references: [id])
  options             ProductOption[]
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  OrderItem           OrderItem[]
  sortOrder           Int                   @default(1)
  OptionValue         OptionValue[]
  isOptionItem        Boolean               @default(false) // checkbox ‚Äúusar como opci√≥n‚Äù
  packOptionSurcharge Float                 @default(0) // ‚Äúprecio para la caja‚Äù
  packMaxItems        Int?
  hasSpecifications   Boolean               @default(false) // muestra el campo de especificaciones
  specificationsTitle String?               @default("Specifications") // t√≠tulo personalizado para las especificaciones
  availability        ProductAvailability   @default(BOTH) // ‚úÖ NUEVO
  hasCatering         Boolean               @default(false)
  cateringTiers       ProductCateringTier[]

  @@index([status])
  @@index([categoryId, sortOrder, name]) // orden y b√∫squedas por categor√≠a
  @@index([name])
  @@index([availability]) // ‚úÖ opcional, ayuda a filtrar r√°pido
}

enum ProductAvailability {
  PICKUP_ONLY
  DELIVERY_ONLY
  BOTH
}

/// Relaci√≥n muchos-a-muchos para asignar grupos de opciones a cada producto
model ProductOption {
  id        String               @id @default(uuid())
  productId String
  groupId   String
  product   Product              @relation(fields: [productId], references: [id])
  group     OptionGroup          @relation(fields: [groupId], references: [id])
  values    ProductOptionValue[]
  sortOrder Int                  @default(1) // ‚úÖ orden del grupo dentro de ESTE producto

  @@index([productId, sortOrder])
}

/// Valores seleccionables de un producto (cada vez que el cliente elige uno)
model ProductOptionValue {
  id              String        @id @default(uuid())
  productOptionId String
  valueId         String
  productOption   ProductOption @relation(fields: [productOptionId], references: [id])
  optionValue     OptionValue   @relation(fields: [valueId], references: [id])
}

/// Grupo gen√©rico de opciones (por ejemplo ‚ÄúScoop #1‚Äù, ‚ÄúScoop #2‚Äù, ‚ÄúToppings‚Äù)
model OptionGroup {
  id             String          @id @default(uuid())
  name           String // p. ej. ‚ÄúScoop Flavors‚Äù
  required       Boolean         @default(true) // obliga a seleccionar al menos minSelectable
  minSelectable  Int             @default(2) // 2 scoops incluidos
  maxSelectable  Int             @default(3) // permite un 3¬∫ scoop (extraPrice)
  productOptions ProductOption[] // relaci√≥n muchos a muchos con productos
  isAvailable    Boolean         @default(true)
  OptionValue    OptionValue[]
  showImages     Boolean         @default(true)
  selectionTitle String? // p. ej. ‚ÄúSelect your scoop flavors‚Äù
}

model OptionValue {
  id                 String               @id @default(uuid())
  group              OptionGroup          @relation(fields: [groupId], references: [id])
  groupId            String
  name               String
  extraPrice         Float                @default(0)
  imageUrl           String?
  description        String               @default("")
  ProductOptionValue ProductOptionValue[]
  isAvailable        Boolean              @default(true)
  productRef         Product?             @relation(fields: [productRefId], references: [id])
  productRefId       String? // Si no es null, esta opci√≥n representa un producto existente
  sortOrder          Int                  @default(1) // ‚úÖ orden del valor dentro del grupo (global)

  @@index([groupId, sortOrder, name])
  @@index([groupId, productRefId])
}

/// Detalle de los items en una orden
model OrderItem {
  id             String  @id @default(uuid())
  orderId        String
  productId      String
  quantity       Int
  price          Float
  chosenOptions  Json?
  order          Order   @relation(fields: [orderId], references: [id])
  product        Product @relation(fields: [productId], references: [id])
  specifications String?
}

/// Orden principal
model Order {
  id                    String      @id @default(uuid())
  orderNumber           String      @unique
  status                OrderStatus @default(PROCESSING)
  createdAt             DateTime    @default(now())
  totalAmount           Float
  subtotal              Float
  paymentMethod         String
  stripePaymentIntentId String?
  userId                String?
  user                  User?       @relation(fields: [userId], references: [id])
  checkoutRequestId     String?     @unique
  failureDetails        Json?

  //  tracking de refunds
  refundedAmount          Float     @default(0) // cu√°nto se ha devuelto en total (USD)
  lastRefundAt            DateTime?
  refundReason            String? // motivo de la devoluci√≥n
  // Datos del cliente
  customerName            String
  customerLastname        String?
  customerEmail           String
  customerPhone           String?
  paymentMethodIdSnapshot String? // opcional recomendado
  // Direcci√≥n de facturaci√≥n / env√≠o
  customerAddress         String // line1
  apartment               String? // line2 (opcional)
  company                 String? // (opcional)
  billingCity             String?
  billingState            String?
  zipcode                 String?

  fulfillmentType FulfillmentType @default(PICKUP)
  specifications  String?         @default("")
  notesFromStore  String?         @default("")
  items           OrderItem[]
  delivery        Delivery? //  relaci√≥n 1‚Äì1 con Delivery
}

model Delivery {
  id String @id @default(uuid())

  // Relaci√≥n 1‚Äì1 con Order
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  provider           DeliveryProvider @default(DOORDASH)
  deliveryRefunded   Boolean?         @default(false)
  externalDeliveryId String           @unique
  doordashDeliveryId String?

  status DeliveryStatus @default(REQUESTED)

  // Datos de entrega
  pickupAddress      String?
  dropoffAddress     String?
  dropoffName        String?
  dropoffPhone       String?
  deliveryRefundedAt DateTime?
  trackingUrl        String?

  // Costos
  deliveryFee Float?
  tipAmount   Float?
  currency    String? @default("USD")

  // Info del driver
  driverName  String?
  driverPhone String?

  // Tiempos
  etaPickup          DateTime?
  etaDropoff         DateTime?
  deliveredAt        DateTime?
  driverInstructions String?

  // üîπ NUEVO: info de cancelaci√≥n
  cancelSource DeliveryCancelSource? // qui√©n inici√≥ la cancelaci√≥n
  cancelReason String? // texto con el motivo
  cancelledAt  DateTime? // cu√°ndo se cancel√≥

  // Debug / auditor√≠a
  rawRequest  Json?
  rawResponse Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provider, status])
  @@index([doordashDeliveryId])
}

enum DeliveryCancelSource {
  CUSTOMER // lo cancel√≥ el cliente
  DRIVER // lo cancel√≥ el dasher
  MERCHANT // lo cancel√≥ la tienda
  SUPPORT // soporte de DoorDash
  SYSTEM // error interno / autom√°tico
  OTHER
}

model StoreConfig {
  id         Int      @id @default(1) // solo un registro
  taxEnabled Boolean  @default(false)
  taxPercent Float    @default(0)
  taxFixed   Float    @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  taxLabel   String   @default("Card fees") // üëà nuevo
}

/// Usuario
model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  name                 String?
  subscribeEmails      Boolean   @default(false)
  password             String
  role                 Roles
  orders               Order[]
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  passwordResetToken   String? // guardar√° el hash del token temporal
  passwordResetExpires DateTime? // marca cu√°ndo vence ese token
  refreshToken         String? // guardar√° el token de refresco activo
}

enum ProductType {
  REGULAR
  SEASONAL
}

enum ProductStatus {
  AVAILABLE
  DISABLED
  OUT_OF_STOCK
}

model Page {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  layout      Json // el JSON con tu √°rbol de componentes
  isPublished Boolean  @default(false) // opcional para drafts
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      String?
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  COMPLETED
  PAYMENT_CAPTURE_FAILED
  AUTHORIZED
  CANCELLED
  REFUNDED
  FAILED
}

enum Roles {
  USER
  ADMIN
  EMPLOYEE
}

enum CouponType {
  PERCENTAGE
  AMOUNT
}

model Coupon {
  id            String     @id @default(uuid())
  code          String     @unique // e.g. "SUMMER25"
  type          CouponType // PERCENTAGE o AMOUNT
  discountValue Float // 25 (porcentaje) o 10.50 (monto)
  expiresAt     DateTime? // si es null, no expira autom√°ticamente
  isLimited     Boolean    @default(false) // si false, usageLimit e usageCount se ignoran
  usageLimit    Int? // m√°ximo de usos en total
  usageCount    Int        @default(0) // cu√°ntas veces se ha canjeado
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  /// (Opcional) Relaci√≥n con redenciones individuales:
  redemptions CouponRedemption[]
}

model CouponRedemption {
  id         String   @id @default(uuid())
  coupon     Coupon   @relation(fields: [couponId], references: [id])
  couponId   String
  userId     String? // si lo limitas por usuario
  orderId    String? // si lo asocias a una orden concreta
  redeemedAt DateTime @default(now())
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum DeliveryProvider {
  DOORDASH
}

enum DeliveryStatus {
  REQUESTED // creado en tu sistema pero a√∫n no enviado a DoorDash
  SENT // request enviada a DoorDash
  ACCEPTED // driver acept√≥
  PICKED_UP // pedido recogido
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  FAILED
}
